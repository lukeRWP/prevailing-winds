---
# Database backup playbook
# Usage: ansible-playbook playbooks/db-backup.yml -i inventories/ENV/hosts.yml

- name: Backup IMP databases
  hosts: imp_databases
  become: yes
  tasks:
    - name: Ensure backup directory exists
      file:
        path: /opt/imp-db/backups
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Run full database backup
      command: >
        mysqldump -u root -p{{ mysql_root_password }}
        --all-databases --single-transaction --routines --triggers
        --result-file=/opt/imp-db/backups/backup-{{ ansible_date_time.iso8601_basic_short }}.sql
      no_log: true

    - name: Compress backup
      command: gzip /opt/imp-db/backups/backup-{{ ansible_date_time.iso8601_basic_short }}.sql
      args:
        creates: /opt/imp-db/backups/backup-{{ ansible_date_time.iso8601_basic_short }}.sql.gz

    - name: Remove backups older than 30 days
      find:
        paths: /opt/imp-db/backups
        patterns: "backup-*.sql.gz"
        age: 30d
      register: old_backups

    - name: Delete old backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      when: old_backups.files | length > 0

    - name: Report backup status
      debug:
        msg: "Database backup complete: /opt/imp-db/backups/backup-{{ ansible_date_time.iso8601_basic_short }}.sql.gz"
