---
# Database backup playbook
# Usage: ansible-playbook playbooks/db-backup.yml -i inventories/ENV/hosts.yml

- name: "Backup {{ app_name | upper }} databases"
  hosts: "{{ group_databases }}"
  become: yes
  vars:
    _backup_dir: "{{ mysql_backup_dir | default('/opt/' + app_name + '-db/backups') }}"
  tasks:
    - name: Ensure backup directory exists
      file:
        path: "{{ _backup_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: Run full database backup
      command: >
        mysqldump -u root -p{{ mysql_root_password }}
        --all-databases --single-transaction --routines --triggers
        --result-file={{ _backup_dir }}/backup-{{ ansible_date_time.iso8601_basic_short }}.sql
      no_log: true

    - name: Compress backup
      command: gzip {{ _backup_dir }}/backup-{{ ansible_date_time.iso8601_basic_short }}.sql
      args:
        creates: "{{ _backup_dir }}/backup-{{ ansible_date_time.iso8601_basic_short }}.sql.gz"

    - name: Remove backups older than 30 days
      find:
        paths: "{{ _backup_dir }}"
        patterns: "backup-*.sql.gz"
        age: 30d
      register: old_backups

    - name: Delete old backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      when: old_backups.files | length > 0

    - name: Report backup status
      debug:
        msg: "Database backup complete: {{ _backup_dir }}/backup-{{ ansible_date_time.iso8601_basic_short }}.sql.gz"
