---
- name: Install nginx and certbot
  apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
    state: present

- name: Remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx

- name: Deploy vhost configuration
  template:
    src: "{{ 'app-https.conf.j2' if nginx_tls_mode != 'none' else 'app-http-only.conf.j2' }}"
    dest: "/etc/nginx/sites-available/{{ app_name }}.conf"
    mode: "0644"
  notify: reload nginx

- name: "Enable {{ app_name }} site"
  file:
    src: "/etc/nginx/sites-available/{{ app_name }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ app_name }}.conf"
    state: link
  notify: reload nginx

- name: Allow HTTP through UFW
  ufw:
    rule: allow
    port: "80"
    proto: tcp

- name: Allow HTTPS through UFW
  ufw:
    rule: allow
    port: "443"
    proto: tcp
  when: nginx_tls_mode != "none"

- name: Hide nginx version in responses
  lineinfile:
    path: /etc/nginx/nginx.conf
    regexp: '^\s*#?\s*server_tokens'
    line: "\tserver_tokens off;"
    insertafter: 'http {'
  notify: reload nginx

- name: Ensure nginx is running
  service:
    name: nginx
    state: started
    enabled: yes

- name: Generate self-signed certificate
  command: >
    openssl req -x509 -nodes -days 365
    -newkey ec -pkeyopt ec_paramgen_curve:P-256
    -keyout /etc/ssl/private/{{ app_name }}-selfsigned.key
    -out /etc/ssl/certs/{{ app_name }}-selfsigned.crt
    -subj "/CN={{ nginx_server_name }}"
  args:
    creates: /etc/ssl/certs/{{ app_name }}-selfsigned.crt
  when: nginx_tls_mode == "selfsigned"
  notify: reload nginx

# For letsencrypt mode: create placeholder self-signed cert at the LE path
# so nginx can start before certbot obtains the real cert
- name: Create Let's Encrypt directory structure
  file:
    path: "/etc/letsencrypt/live/{{ nginx_server_name }}"
    state: directory
    mode: "0755"
  when: nginx_tls_mode == "letsencrypt"

- name: Check for existing Let's Encrypt renewal config
  stat:
    path: "/etc/letsencrypt/renewal/{{ nginx_server_name }}.conf"
  register: le_renewal
  when: nginx_tls_mode == "letsencrypt"

- name: Generate placeholder cert for nginx startup
  command: >
    openssl req -x509 -nodes -days 1
    -newkey ec -pkeyopt ec_paramgen_curve:P-256
    -keyout /etc/letsencrypt/live/{{ nginx_server_name }}/privkey.pem
    -out /etc/letsencrypt/live/{{ nginx_server_name }}/fullchain.pem
    -subj "/CN={{ nginx_server_name }}"
  when: nginx_tls_mode == "letsencrypt" and not (le_renewal.stat.exists | default(false))
  notify: reload nginx

- name: Flush handlers (ensure nginx starts with placeholder cert)
  meta: flush_handlers

- name: Obtain Let's Encrypt certificate
  command: >
    certbot --nginx
    -d {{ nginx_server_name }}
    --non-interactive
    --agree-tos
    -m {{ nginx_certbot_email }}
    --redirect
  args:
    creates: "/etc/letsencrypt/renewal/{{ nginx_server_name }}.conf"
  when: nginx_tls_mode == "letsencrypt"
  notify: reload nginx

- name: Enable certbot auto-renewal timer
  systemd:
    name: certbot.timer
    state: started
    enabled: yes
  when: nginx_tls_mode == "letsencrypt"
