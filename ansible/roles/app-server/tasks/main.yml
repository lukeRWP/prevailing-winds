---
- name: Create server directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0755"
  loop:
    - "{{ app_server_base_dir }}"
    - "{{ app_server_releases_dir }}"
    - "{{ app_server_shared_dir }}"
    - "{{ app_server_shared_dir }}/mysql-ssl"
    - "{{ app_server_shared_dir }}/tessdata"

# --- Deploy SSL certs fetched to controller, then clean up temp files ---
- name: Deploy SSL certificates from controller staging area
  block:
    - name: Deploy MySQL client SSL certificates
      copy:
        src: "{{ ssl_staging_dir | default('/tmp/ansible-staging/ssl-certs') }}/{{ hostvars[groups[group_databases][0]].inventory_hostname }}/{{ item.name }}"
        dest: "{{ app_server_shared_dir }}/mysql-ssl/{{ item.name }}"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "{{ item.mode }}"
      loop:
        - { name: "ca.pem", mode: "0644" }
        - { name: "client-cert.pem", mode: "0644" }
        - { name: "client-key.pem", mode: "0600" }
      when: mysql_require_ssl | default(true) | bool
      notify: restart app-server

    - name: Deploy MinIO TLS certificate for Node.js trust
      copy:
        src: "{{ ssl_staging_dir | default('/tmp/ansible-staging/ssl-certs') }}/{{ hostvars[groups[group_storage][0]].inventory_hostname }}/public.crt"
        dest: "{{ app_server_shared_dir }}/minio-ca.crt"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0644"
      when: groups[group_storage] is defined and groups[group_storage] | length > 0
      notify: restart app-server

  always:
    - name: Remove temporary SSL certs from Ansible controller
      file:
        path: "{{ ssl_staging_dir | default('/tmp/ansible-staging/ssl-certs') }}"
        state: absent
      delegate_to: localhost
      become: no
      run_once: true

# --- Build app_env_vars from infrastructure when not provided ---
- name: Build app_env_vars from infrastructure vars
  set_fact:
    app_env_vars: >-
      {{
        {
          'NODE_ENV': app_server_node_env | default('production'),
          'APP_NAME': app_name,
          'PORT': app_server_port | default(2727) | string,
          'CLIENT_URL': 'https://' + nginx_server_name,
          'MYSQL_URL': hostvars[groups[group_databases][0]].ansible_host,
          'MYSQL_USER': vault_mysql_user,
          'MYSQL_PASSWORD': vault_mysql_password,
          'MYSQL_USE_SSL': (mysql_require_ssl | default(true)) | string | lower,
          'MYSQL_SSL_USER': vault_mysql_ssl_user,
          'MYSQL_SSL_PASSWORD': vault_mysql_ssl_password,
          'MYSQL_SSL_PATH': app_server_shared_dir + '/mysql-ssl',
          'MAIN_DATABASE': 'IMP_PROJECTS',
          'PROJECT_DB': 'IMP_PROJECTS',
          'PROGRAM_DB': 'IMP_PROGRAMS',
          'LOCATION_DB': 'IMP_LOCATIONS',
          'USER_DB': 'IMP_USERS',
          'MILESTONE_DB': 'IMP_MILESTONES',
          'CAPITAL_DB': 'IMP_CAPITAL',
          'ADMIN_DB': 'IMP_ADMIN',
          'REPORTING_DB': 'IMP_REPORTING',
          'ANALYTICS_DB': 'IMP_ANALYTICS',
          'IMPORT_DB': 'IMP_IMPORTS',
          'EXPORT_DB': 'IMP_EXPORTS',
          'FILES_DB': 'IMP_FILES',
          'NOTES_DB': 'IMP_NOTES',
          'S3_BUCKET': app_name + '-files',
          'S3_REGION': 'us-east-1',
          'S3_ACCESS_KEY': vault_s3_access_key,
          'S3_SECRET_KEY': vault_s3_secret_key,
          'S3_ENDPOINT': 'https://' + hostvars[groups[group_storage][0]].ansible_host + ':9000',
          'S3_PUBLIC_ENDPOINT': 'https://minio.' + env_name + '.razorwire-productions.com:9000',
          'NODE_EXTRA_CA_CERTS': app_server_shared_dir + '/minio-ca.crt',
          'AUTH_SECRET_ENCRYPTION_KEY': vault_auth_secret_key,
          'COOKIE_SECRET': vault_cookie_secret,
          'BYPASS_AUTH': 'false',
          'FILE_ENCRYPTION_ENABLED': 'false',
          'FILE_ENCRYPTION_MASTER_KEY': vault_file_encryption_key,
          'FILE_ENCRYPTION_KEY_VERSION': '1',
          'SYNC_ENCRYPTION_KEY': vault_sync_encryption_key,
          'ENCRYPT_STORAGE_KEYS': 'false',
          'LOG_LEVEL': ('debug' if env_name == 'dev' else 'info'),
          'LOG_TO_DATABASE': 'true',
          'LOG_TO_FILE': 'true',
          'LOG_TO_CONSOLE': 'true',
          'SERVER_ID': app_name + '-api-' + env_name,
          'SERVICE_NAME': app_name + '-api',
          'SYNC_ADMIN_DB': 'IMP_ADMIN',
          'SYNC_TARGETS_TABLE': 'SYNC_TARGETS',
          'SYNC_ATTEMPTS_TABLE': 'SYNC_ATTEMPTS',
          'SYNC_CACHE_TTL': '300000',
          'SYNC_MAX_RETRIES': '3',
          'BQ_PROJECT_ID': '',
          'BQ_DATASET': 'EXPANSIONS_PLANNING',
          'SLACK_WEBHOOK_URL': ''
        }
      }}
  when: app_env_vars | length == 0
  no_log: true

- name: Deploy server .env from app_env_vars
  template:
    src: env.j2
    dest: "{{ app_server_shared_dir }}/.env"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0600"
  no_log: true

- name: Deploy server systemd unit
  template:
    src: app-server.service.j2
    dest: /etc/systemd/system/{{ app_server_service_name }}.service
    mode: "0644"
  notify:
    - reload systemd

- name: Allow server port through UFW
  ufw:
    rule: allow
    port: "{{ app_server_port }}"
    proto: tcp
    from_ip: "{{ client_server_ip | default(internal_cidr) }}"

- name: Allow server port from management network (runner access)
  ufw:
    rule: allow
    port: "{{ app_server_port }}"
    proto: tcp
    from_ip: "{{ management_cidr }}"
  when: management_cidr is defined and management_cidr != internal_cidr

- name: Configure PM2 log rotation
  copy:
    content: |
      /home/{{ deploy_user }}/.pm2/logs/*.log {
        daily
        rotate 14
        compress
        delaycompress
        missingok
        notifempty
        copytruncate
      }
    dest: /etc/logrotate.d/pm2
    mode: "0644"
