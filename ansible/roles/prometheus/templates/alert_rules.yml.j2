groups:
  - name: imp_node_alerts
    rules:
      # VM is down
      - alert: InstanceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          environment: "{{ '{{' }} $labels.environment {{ '}}' }}"
        annotations:
          summary: "Instance {{ '{{' }} $labels.instance {{ '}}' }} is down"
          description: "{{ '{{' }} $labels.job {{ '}}' }} target {{ '{{' }} $labels.instance {{ '}}' }} has been unreachable for 2 minutes."

      # High CPU usage
      - alert: HighCpuUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "CPU usage is above 85% for 5 minutes (current: {{ '{{' }} $value | printf \"%.1f\" {{ '}}' }}%)"

      # High memory usage
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Memory usage above 90% (current: {{ '{{' }} $value | printf \"%.1f\" {{ '}}' }}%)"

      # Disk space running low
      - alert: DiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Root filesystem is {{ '{{' }} $value | printf \"%.1f\" {{ '}}' }}% full"

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical disk space on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Root filesystem is {{ '{{' }} $value | printf \"%.1f\" {{ '}}' }}% full â€” action required"

  - name: imp_app_alerts
    rules:
      # IMP server is down
      - alert: ImpServerDown
        expr: up{job="imp-server"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "IMP server is down"
          description: "The IMP API server has been unreachable for 1 minute."

      # High request latency
      - alert: HighRequestLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="imp-server"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API latency"
          description: "95th percentile request latency is above 2 seconds"

  - name: imp_database_alerts
    rules:
      # MySQL is down
      - alert: MysqlDown
        expr: up{job="mysql"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL is unreachable"
          description: "MySQL exporter on {{ '{{' }} $labels.instance {{ '}}' }} is down."

  - name: imp_cert_alerts
    rules:
      # TLS certificate expiring within 7 days
      - alert: CertExpiringSoon
        expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 7
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "TLS cert expiring on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Certificate expires in {{ '{{' }} $value | printf \"%.0f\" {{ '}}' }} days"

      # TLS certificate expiring within 30 days
      - alert: CertExpiryWarning
        expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "TLS cert expiring soon on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "Certificate expires in {{ '{{' }} $value | printf \"%.0f\" {{ '}}' }} days"

  - name: imp_storage_alerts
    rules:
      # MinIO is down
      - alert: MinioDown
        expr: up{job="minio"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "MinIO storage is down"
          description: "MinIO on {{ '{{' }} $labels.instance {{ '}}' }} has been unreachable for 2 minutes."

      # MySQL data disk filling up
      - alert: MysqlDiskSpaceLow
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/var/lib/mysql"} / node_filesystem_size_bytes{mountpoint="/var/lib/mysql"})) * 100 > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "MySQL data disk filling up on {{ '{{' }} $labels.instance {{ '}}' }}"
          description: "MySQL data partition is {{ '{{' }} $value | printf \"%.1f\" {{ '}}' }}% full"
