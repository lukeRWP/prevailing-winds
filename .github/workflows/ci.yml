name: CI

on:
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  terraform-validate:
    name: Terraform Validate
    runs-on: self-hosted
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269571ae # v3
        with:
          terraform_version: "1.9"

      - name: Terraform fmt check
        run: terraform fmt -check -recursive -diff

      - name: Terraform init (validate only)
        run: terraform init -backend=false -input=false

      - name: Terraform validate
        run: terraform validate

      - name: Validate modules
        run: |
          for module in modules/*/; do
            echo "=== Validating $module ==="
            cd "$module"
            terraform init -backend=false -input=false
            terraform validate
            cd ../..
          done

  ansible-lint:
    name: Ansible Lint
    runs-on: self-hosted
    defaults:
      run:
        working-directory: ansible
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Install ansible-lint
        run: pip install ansible-lint ansible-core

      - name: Run ansible-lint on playbooks
        run: ansible-lint playbooks/*.yml
        continue-on-error: true

      - name: Validate playbook syntax
        run: |
          for pb in playbooks/*.yml; do
            echo "=== Checking syntax: $pb ==="
            ansible-playbook --syntax-check "$pb" 2>&1 || echo "::warning::Syntax check failed for $pb"
          done
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"

  orchestrator-check:
    name: Orchestrator Lint
    runs-on: self-hosted
    defaults:
      run:
        working-directory: orchestrator/api
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Verify startup
        run: |
          timeout 5 node index.js || [ $? -eq 124 ]
        env:
          PORT: 9999
          NODE_ENV: test
          ADMIN_TOKEN: test-token
          VAULT_SKIP: "true"
